{% extends "base.html" %}
{% block head %}
<title>My dashboard</title>
{% endblock %}
{% block scripts %}
    <link rel="stylesheet" href="/static/css/progress_bar.css" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="/static/js/map_utils.js"></script>
    <script src="/static/js/graph_utils.js"></script>
    <script src="/static/js/geo.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script type="text/html" id="session-template">
      <div class="small-12 columns">
        <div class="panel">
          <h3 class="session_id"><a data-bind="{attr: {href: '#' + number()}, text: '#' + number()}"></a></h3>
          <p data-bind="text: date"></p>
        </div>
      </div>
    </script>
    <script type="text/html" id="session-details-template">
      <div class="large-6 medium-12 columns logbook-entry" data-bind="css: {leftalign: number%2==0}">
        <div class="large-12 columns" data-bind="attr: {id: number}" >
          <div class="small-12 columns">
            <h3 class="session_id"><a data-bind="{attr: {href: '/dashboard/logbook/' + number()}, text: '#' + number()}"></a></h3>
            <p class="datetime" data-bind="text: date"></p>
          </div>
        </div>
        <div class="logbook-details large-12 columns" >
          <div class="small-12 columns">
            <p>Free fall time: <span data-bind="{text: freefalltime}"></span></p>
          </div>
          <div class="small-12 columns">
            <p>Exit altitude: <span data-bind="{text: exitAltitude}"></span></p>
          </div>
          <div class="small-12 columns">
            <p>Deployment altitude: <span data-bind="{text: deploymentAltitude}"></span></p>
          </div>
          <div class="small-12 columns">
            <p>Max velocity: <span data-bind="{text: maxVelocity}"></span></p>
          </div>
          <div class="small-12 columns">
            <p>Location: <span data-bind="attr: {id:'session-location-'+number()}, text: location_name"></span></p>
          </div>
          <div class="small-12 columns">
            <textarea placeholder="Notes" data-bind="value: notes"></textarea>
          </div>
          <div class="small-12 columns">
            <div id="share-session-button" class="medium-6 small-12 columns medium semi-round button" data-bind="click: save"><i class="step fi-save size-16"></i>Save</div>
          </div>
        </div>
      </div>
    </script>
    <script type="text/javascript">

      function getMyData() {  
        getJSONResponse('/dashboard/logbook_entries', initialize);
      }

      var map;
      var myData;
      function initialize(data) {
        
      }
      google.maps.event.addDomListener(window, 'load', getMyData);
    </script>
    <script type="text/javascript">

      function validateValue(value) {
        return value == 'N/A' ? 0 : value;
      }

      function validateReverseValue(value) {
        return value == 0 || value == 'N/A' ? 'N/A' : value;
      }

      function SkydivingSession(date, number, metrics, location, location_name, notes, id, fromRaw) {
        var self = this;
        self.date = ko.observable(date);
        self.number = ko.observable(number);
        self.freefalltime = ko.observable(validateReverseValue(metrics.freefalltime));
        self.exitAltitude = ko.observable(validateReverseValue(metrics.exitAltitude));
        self.deploymentAltitude = ko.observable(validateReverseValue(metrics.deploymentAltitude));
        self.maxVelocity = ko.observable(validateReverseValue(metrics.maxVelocity));
        self.latitude = location.lat;
        self.longitude = location.lng;
        self.location_name = ko.observable(location_name);
        if (self.location_name() == null) {
          getLocationDetails(self.latitude, self.longitude, self.location_name, null);
        }
        self.notes = ko.observable(notes);
        self.id = id;
        self.fromRaw = fromRaw;
        self.save = function() {
          var logbook_data = {
                         'id':self.id,
                         'date':self.date().getTime(),
                         'freefalltime':validateValue(self.freefalltime()),
                         'exitAltitude':validateValue(self.exitAltitude()),
                         'deploymentAltitude':validateValue(self.deploymentAltitude()),
                         'maxVerticalVelocity':validateValue(self.maxVelocity()),
                         'latitude':self.latitude,
                         'longitude':self.longitude,
                         'location_name':self.location_name(),
                         'notes':self.notes(),
                         'fromRaw':self.fromRaw
                     };
            $.ajax({
            url: '/logbook/save/',
            type: 'post',
            dataType: 'json',
            success: function (data) {
              console.log(data);
            },
            data: logbook_data
        });


        }
      }

      function initialize(session_data) {

        var sessions = ko.observableArray();
        for (var i = session_data.length - 1; i >= 0; i--) {
          if ('raw' in session_data[i]) {
            var session = session_data[i]['raw'];
            var date = new Date(session.gpsEntries[0].timestamp)
            var metrics = calculate_metrics(session);
            var location = {lat:session.gpsEntries[0].latitude, lng: session.gpsEntries[0].longitude};
            var ss = new SkydivingSession(date, i, metrics, location, null, "", session_data[i]['id'], true);
            ss.timestamp = session.gpsEntries[0].timestamp;
            sessions.push(ss);
          } else {
            var date = new Date(session_data[i].timeInMillis)
            var metrics = session_data[i].metrics;
            var location = {lat: session_data[i].latitude, lng: session_data[i].longitude};
            var ss = new SkydivingSession(date, i, metrics, location, session_data[i].location, session_data[i].notes, session_data[i].id, false)
            ss.timestamp = session_data[i].timeInMillis;
            sessions.push(ss);
          }

          sessions = sessions.sort(function(a,b) {
            return -a.timestamp + b.timestamp;
          });

        }

        prepareUI(sessions);
      }


      var model;
      function prepareUI(sessions) {
         model = {"sessions":sessions};
         ko.applyBindings(model);
      }
        
    </script>
{% endblock %}
{% block content %}
    
<div class="row fullHeight fullWidth">
  <div class="medium-8 small-8 columns fullHeight">
    <div id="session-logbook">
      <div class="row">
        <div data-bind="template: { name: 'session-details-template', foreach: sessions }">
        </div>
      </div>
    </div>
  </div>
    <div class="medium-4 small-4 columns fullHeight">
       
       <div id="session-list" class="fullHeight">
          <div class="small-12 columns">
            <h3>My past sessions</h3>
          </div>
          <hr />
          <div class="row" data-bind="template: { name: 'session-template', foreach: sessions }">

          </div> 
       </div>
    </div>
 </div>

<div id="dialog" title="Share your session" style="display: none">
  <p id="link-share" style="color: black"></p>
</div>
{% endblock content %}