{% extends "base.html" %}
{% block head %}
<title>My dashboard</title>
{% endblock %}
{% block scripts %}

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?">
    </script>
    <link rel="stylesheet" href="/static/css/progress_bar.css" />
    
    <script type="text/javascript">

      function getMyData() {
        getJSONResponse('/dashboard/session', initialize);
      }

      var map;
      var myData;
      function initialize(data) {
        var latitude = data.gpsEntries[0].latitude;
        var longitude = data.gpsEntries[0].longitude;
        var mapOptions = {
          center: { lat: latitude, lng: longitude},
          zoom: 16
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        myData = data;
        setUpControlPanel();
      }
      google.maps.event.addDomListener(window, 'load', getMyData);
    </script>
    <script type="text/javascript">
      var marker = null;
      function startAnimating(data) {
          
          var lat = data.gpsEntries[0].latitude;
          var lng = data.gpsEntries[0].longitude;
          var myLatlng = new google.maps.LatLng(lat,lng);
          var mapOptions = {
            zoom: 16,
            center: myLatlng
          }

          if (marker == null) {
            marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: 'GPS data'
            });
            marker.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png");
          
          }
          
          var altitudeEntries = data.barometerEntries;
          altitudeEntries = altitudeEntries.sort(function(entryA, entryB) {
            return entryA.timestamp - entryB.timestamp;
          });
          if (altitudeEntries.length > 0) {
            var maxAlt = altitudeEntries[0].altitude;
            var minAlt = altitudeEntries[0].altitude;
            $.each(altitudeEntries, function(key, alt) {
              if (alt.altitude > maxAlt) {
                maxAlt = alt.altitude;
              }
              if (alt.altitude < minAlt) {
                minAlt = alt.altitude;
              }
            });
            animateAltitude(altitudeEntries, 0, maxAlt, minAlt);          
          }

          moveMarker(0, marker, data);

              
      }
      
      function drawPath(data) {
          var flightPlanCoordinates = [];
          for (var i = 0; i < data.gpsEntries.length; i++) {
              flightPlanCoordinates.push(new google.maps.LatLng(data.gpsEntries[i].latitude, data.gpsEntries[i].longitude));
          }
          var flightPath = new google.maps.Polyline({
          path: flightPlanCoordinates,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
          });

          flightPath.setMap(map);
      }

      var speed = 100;


      function animateAltitude(altitudes, i, maxAlt, minAlt) {
        var altitudeEntry = altitudes[i];

        var timestamp = altitudeEntry.timestamp;
        while ((i < (altitudes.length - 1)) && altitudes[i+1].timestamp <= altitudes[i].timestamp) {
          i = i + 1;
        }
        if (i < altitudes.length - 1) {
          var timeDifference = altitudes[i+1].timestamp - timestamp;
          setTimeout(function () { animateAltitude(altitudes, i + 1, maxAlt, minAlt); }, timeDifference/speed);
        }

        if (i >= altitudes.length)
          return;
        
        var percentage = (altitudeEntry.altitude - minAlt)/(maxAlt - minAlt);
        var progress = Math.round(percentage*100);
        $('#current-altitude').text(altitudeEntry.altitude);
        $('#progress_bar').data('progress', percentage);
        $('#progress_bar').height(progress + "%");
        
        
      } 
        
      

      function moveMarker(i, marker, data) {
        if (i < data.gpsEntries.length - 1) {
          var timeout = data.gpsEntries[i+1].timestamp - data.gpsEntries[i].timestamp;
          setTimeout(function () { moveMarker(i+1, marker, data); }, timeout/speed);
        }
        var lat = data.gpsEntries[i].latitude;
        var lng = data.gpsEntries[i].longitude;
        var position = new google.maps.LatLng(lat, lng);
   
        marker.setPosition(position);
        map.panTo(position);     
        

      }

      function setUpControlPanel() {
        $('#session-path-button').click(function() {
          drawPath(myData);
        });

        $('#animation-button').click(function() {
          startAnimating(myData);
        });
        $('#real-speed-button').click(function() {
          speed = 1;
        });
        $('#fast-forward-button').click(function() {
          speed = 100;
        });
      }

        
    </script>
{% endblock %}
{% block content %}
    
<div class="row fullHeight fullWidth">
  <div class="large-10 medium-8 small-8 columns fullHeight">
    <div id="map-canvas"></div>
  </div>
    <div class="large-2 medium-4 small-4 columns fullHeight">
       <div id="control-panel" class="fullHeight">
          <div class="row">
            <div id="session-path-button" class="medium-12 columns medium round success button">Draw your session path</div>
          </div>
          <div class="row">
            <div id="animation-button" class="medium-12 columns medium round button">Show animation</div>
          </div>
          <div class="row">
            <div id="charts-button" class="medium-12 columns medium round alert button">View charts</div>
          </div>
          <div class="row">
            <div id="real-speed-button" class="medium-6 small-12 columns medium round button">Real speed</div>

            <div id="fast-forward-button" class="medium-6 small-12 columns medium round success button">Fast forward</div>
          </div>

          <div class="row">
            <div class="medium-8 columns">
              <div class="callout panel" style="margin-top: 33%">
                <p id="current-altitude"></p>
              </div>
            </div>
            <div class="medium-4 columns">
              <div class="skill">
                  <div class="outer">
                      <div id="progress_bar" class="inner" data-progress="0%">
                          <div></div>
                      </div>        
                  </div>
              </div>
            </div>
          </div>
       </div>
    </div>
  </div>
</div>
{% endblock content %}