{% extends "base.html" %}
{% block head %}
<title>My dashboard</title>
{% endblock %}
{% block scripts %}
<style type="text/css">
      #control-panel {background-color: blue;}
      #map-canvas, .fullHeight {height: 100%;}
      .fullWidth {margin: 0; max-width: 100%}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?">
    </script>
    
    
    <script type="text/javascript">

      function getMyData() {
        getJSONResponse('/dashboard/session', initialize);
      }

      var map;
      var myData;
      function initialize(data) {
        var latitude = data.gpsEntries[0].latitude;
        var longitude = data.gpsEntries[0].longitude;
        var mapOptions = {
          center: { lat: latitude, lng: longitude},
          zoom: 16
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        myData = data;
        setUpControlPanel();
      }
      google.maps.event.addDomListener(window, 'load', getMyData);
    </script>
    <script type="text/javascript">
      var marker = null;
      function startAnimating(data) {
      
          var lat = data.gpsEntries[0].latitude;
          var lng = data.gpsEntries[0].longitude;
          var myLatlng = new google.maps.LatLng(lat,lng);
          var mapOptions = {
            zoom: 16,
            center: myLatlng
          }

          if (marker == null) {
            var marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: 'GPS data'
            });
            marker.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png");
          
          }
          
          moveMarker(0, marker, data);
          
          
              
      }
      
      function drawPath(data) {
          var flightPlanCoordinates = [];
          for (var i = 0; i < data.gpsEntries.length; i++) {
              flightPlanCoordinates.push(new google.maps.LatLng(data.gpsEntries[i].latitude, data.gpsEntries[i].longitude));
          }
          var flightPath = new google.maps.Polyline({
          path: flightPlanCoordinates,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
          });

          flightPath.setMap(map);
      }
        
      
      
      function moveMarker(i, marker, data) {
              var lat = data.gpsEntries[i].latitude;
              var lng = data.gpsEntries[i].longitude;
              var position = new google.maps.LatLng(lat, lng);
              marker.setPosition(position);
              map.panTo(position);
              if (i < data.gpsEntries.length - 1) {
                var timeout = data.gpsEntries[i+1].timestamp - data.gpsEntries[i].timestamp;
                setTimeout(function () { moveMarker(i+1, marker, data); }, timeout/100);
            }
      }

      function setUpControlPanel() {
        $('#session-path-button').click(function() {
          drawPath(myData);
        });

        $('#animation-button').click(function() {
          startAnimating(myData);
        });
      }

        
    </script>
{% endblock %}
{% block content %}
    
<div class="row fullHeight fullWidth">
  <div class="large-10 medium-8 small-8 columns fullHeight">
    <div id="map-canvas"></div>
  </div>
    <div class="large-2 medium-4 small-4 columns fullHeight">
       <div id="control-panel" class="fullHeight">
          <div class="row">
            <div id="session-path-button" class="medium12 columns medium round success button">Draw your session path</div>
          </div>
          <div class="row">
            <div id="animation-button" class="medium12 columns medium round button">Show animation</div>
          </div>
          <div class="row">
            <div id="charts-button" class="medium12 columns medium round alert button">View charts</div>
          </div>
       </div>
    </div>
  </div>
</div>
{% endblock content %}